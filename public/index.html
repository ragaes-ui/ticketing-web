<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RCELLFEST | Beli Tiket Konser & Event Online</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    
    <script src="https://app.sandbox.midtrans.com/snap/snap.js" data-client-key="SB-Mid-server-bJeyNsEecyuBT4Lm6KC55-zg"></script>
    
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Cdefs%3E%3ClinearGradient id='a' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' stop-color='%230049CC'/%3E%3Cstop offset='100%25' stop-color='%23007bff'/%3E%3C/linearGradient%3E%3C/defs%3E%3Ccircle cx='32' cy='32' r='32' fill='url(%23a)'/%3E%3Cpath d='M21 18h8c5 0 9 3.5 9 8 0 3-1.8 5.7-4.5 7.2l5 8.8h-5l-4.2-7.5h-3.3v7.5h-5V18zm5 4v7h3c2.5 0 4.5-1.8 4.5-3.5S31.5 22 29 22h-3z' fill='white'/%3E%3Cpath d='M36 18h13v4h-8v6h7v4h-7v10h-5V18z' fill='white'/%3E%3C/svg%3E" type="image/svg+xml">

    <style>
        :root { --primary-blue: #0049CC; --dark-navy: #0e1e3b; --text-dark: #333; }
        body { font-family: 'Inter', sans-serif; background-color: white; color: var(--text-dark); padding-top: 76px; overflow-x: hidden; }
        
        .navbar { background-color: white; box-shadow: 0 1px 10px rgba(0,0,0,0.05); padding: 12px 0; height: 76px; }
        .navbar-brand { font-weight: 800; color: var(--primary-blue) !important; font-size: 1.4rem; display: flex; align-items: center; gap: 8px; }
        .nav-link { font-weight: 500; color: #555; margin: 0 10px; }
        .nav-link:hover { color: var(--primary-blue); }

        .hero-section { background: linear-gradient(135deg, #0049CC 0%, #007bff 100%); padding: 60px 0 100px 0; color: white; position: relative; }
        .hero-title { font-weight: 800; line-height: 1.2; }
        .hero-bg-circle { position: absolute; width: 300px; height: 300px; background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 70%); border-radius: 50%; top: -50px; right: -50px; pointer-events: none; }
        
        @media (max-width: 768px) { .hero-title { font-size: 2rem; } }
        @media (min-width: 769px) { .hero-title { font-size: 3.5rem; } }

        .search-wrapper { margin-top: -45px; position: relative; z-index: 10; padding: 0 15px; }
        .search-box { background: white; padding: 8px; border-radius: 50px; box-shadow: 0 8px 25px rgba(0,73,204,0.15); display: flex; align-items: center; width: 100%; max-width: 700px; margin: 0 auto; }
        .search-input { border: none; outline: none; flex-grow: 1; padding: 10px 15px; width: 100%; }
        .btn-search { background: var(--primary-blue); color: white; border: none; padding: 10px 25px; border-radius: 40px; font-weight: 600; }
        
        .category-item { text-align: center; cursor: pointer; transition: 0.3s; padding: 10px; border-radius: 12px; }
        .category-item:hover, .category-item.active { background: #f0f7ff; transform: scale(1.05); }
        .category-item.active .cat-text { color: var(--primary-blue); font-weight: 800; }
        .icon-circle { width: 45px; height: 45px; background: #e6f0ff; color: var(--primary-blue); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; margin: 0 auto 8px auto; }
        .cat-text { font-size: 0.8rem; font-weight: 600; color: #555; }

        .card-event { border: 1px solid #eee; border-radius: 16px; overflow: hidden; transition: transform 0.2s, box-shadow 0.2s; background: white; height: 100%; display: flex; flex-direction: column; cursor: pointer; }
        .card-event:hover { transform: translateY(-5px); box-shadow: 0 15px 30px rgba(0,0,0,0.08); }
        .card-img-top { height: 160px; background: linear-gradient(135deg, #0049CC, #4facfe); position: relative; display: flex; align-items: center; justify-content: center; color: white; }
        .category-badge-img { position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.5); color: white; font-size: 0.7rem; padding: 4px 8px; border-radius: 4px; backdrop-filter: blur(4px); }
        .date-float { position: absolute; bottom: 10px; left: 10px; background: white; color: #333; padding: 4px 10px; border-radius: 8px; font-weight: 700; font-size: 0.75rem; }
        .card-body { padding: 15px; flex-grow: 1; display: flex; flex-direction: column; }
        .event-title { font-weight: 700; font-size: 1rem; margin-bottom: 5px; line-height: 1.4; }
        .price-val { font-size: 1rem; font-weight: 700; color: #ff5e1f; margin-bottom: 15px; }
        
        .btn-outline-book { border: 1px solid var(--primary-blue); color: var(--primary-blue); font-weight: 600; padding: 8px; border-radius: 8px; background: white; width: 100%; margin-top: auto; font-size: 0.9rem; position: relative; z-index: 2; }
        .btn-outline-book:hover { background: var(--primary-blue); color: white; }
        .btn-outline-book.disabled { border-color: #ddd; color: #aaa; background: #f9f9f9; }

        .footer-loket { background-color: var(--dark-navy); color: white; padding: 50px 0 30px 0; margin-top: 60px; font-size: 0.85rem; }
        .footer-link { display: block; color: #b0c0d6; text-decoration: none; margin-bottom: 8px; }
        .footer-link:hover { color: white; text-decoration: underline; }
        
        .btn-help-floating { position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px; background: white; color: var(--primary-blue); border: 2px solid var(--primary-blue); border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 20px rgba(0, 73, 204, 0.2); z-index: 9999; font-size: 1.5rem; transition: 0.3s; }
        .btn-help-floating:hover { transform: translateY(-5px); background: var(--primary-blue); color: white; }
    </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg fixed-top">
        <div class="container">
            <a class="navbar-brand" href="#"><i class="bi bi-ticket-detailed-fill"></i> RCELLFEST</a>
            <div class="collapse navbar-collapse justify-content-center d-none d-lg-block">
                <ul class="navbar-nav">
                    <li class="nav-item"><a class="nav-link" href="#">Jelajah</a></li>
                    <li class="nav-item"><a class="nav-link" href="#">Tentang Kami</a></li>
                </ul>
            </div>
            <div id="navUserArea">
                <a href="user-login.html" class="btn btn-outline-primary rounded-pill px-4 fw-bold btn-sm">Masuk / Daftar</a>
            </div>
        </div>
    </nav>

    <section class="hero-section text-center">
        <div class="hero-bg-circle"></div>
        <div class="container position-relative z-1">
            <h1 class="hero-title mb-2">Satu sentuhan,<br>Semua solusi untuk event anda.</h1>
            <p class="hero-lead opacity-75 mb-0">Jelajahi ribuan event seru & konser musik, Yuk booking tiket mu Sekarang.</p>
        </div>
    </section>

    <div class="search-wrapper mb-4">
        <div class="search-box">
            <i class="bi bi-search text-secondary ms-2"></i>
            <input type="text" id="searchInput" class="search-input" placeholder="Cari konser...">
            <button onclick="searchEvent()" class="btn-search">Cari</button>
        </div>
    </div>

    <div class="container">
        <div class="row justify-content-center mb-5 g-2 px-2">
            <div class="col-3 col-md-2" onclick="filterCategory('All')"><div class="category-item active" id="btn-cat-All"><div class="icon-circle"><i class="bi bi-grid-fill"></i></div><div class="cat-text">Semua</div></div></div>
            <div class="col-3 col-md-2" onclick="filterCategory('Konser')"><div class="category-item" id="btn-cat-Konser"><div class="icon-circle"><i class="bi bi-music-note-beamed"></i></div><div class="cat-text">Konser</div></div></div>
            <div class="col-3 col-md-2" onclick="filterCategory('Olahraga')"><div class="category-item" id="btn-cat-Olahraga"><div class="icon-circle"><i class="bi bi-trophy-fill"></i></div><div class="cat-text">Olahraga</div></div></div>
            <div class="col-3 col-md-2" onclick="filterCategory('Workshop')"><div class="category-item" id="btn-cat-Workshop"><div class="icon-circle"><i class="bi bi-palette-fill"></i></div><div class="cat-text">Workshop</div></div></div>
        </div>

        <div class="d-flex justify-content-between align-items-center mb-3 px-2">
            <h5 class="fw-bold m-0">üî• Pilihan Hari Ini</h5>
            <a href="#" class="text-decoration-none fw-bold small" onclick="filterCategory('All')">Lihat Semua <i class="bi bi-arrow-right"></i></a>
        </div>

        <div class="row g-3" id="event-list">
            <div class="col-12 text-center py-5"><div class="spinner-border text-primary" role="status"></div><p class="mt-2 text-secondary small">Memuat event...</p></div>
        </div>
    </div>

    <a href="mailto:ragaganz01@gmail.com?subject=Bantuan%20RCELLFEST" class="btn-help-floating"><i class="bi bi-envelope-heart-fill"></i></a>

    <footer class="footer-loket">
        <div class="container">
            <div class="row g-4">
                <div class="col-6 col-lg-3"><div class="footer-head">Tentang</div><a href="#" class="footer-link">Tentang Kami</a></div>
                <div class="col-6 col-lg-3"><div class="footer-head">Penyelenggara</div><a href="login.html" class="footer-link text-warning">Login Admin</a></div>
                <div class="col-lg-3"><div class="footer-head">Ikuti Kami</div><small class="text-white-50">&copy; 2026 Rcelltech inc Global.</small></div>
            </div>
        </div>
    </footer>

    <div class="modal fade" id="eventDetailModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-body p-4">
                    <button type="button" class="btn-close float-end" data-bs-dismiss="modal"></button>
                    <h2 class="fw-bold mb-1" id="modalTitle">Judul Event</h2>
                    <hr>
                    <p class="modal-desc-text" id="modalDesc"></p>
                    <div class="mt-4 p-3 bg-light rounded-3 d-flex justify-content-between align-items-center">
                        <div><small class="text-secondary">Harga Tiket</small><div class="modal-price-tag" id="modalPrice">Rp 0</div></div>
                        <button id="btnModalBuy" class="btn btn-primary btn-lg rounded-pill fw-bold">Beli Tiket</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        let allEvents = [];
        let detailModal; 

        document.addEventListener('DOMContentLoaded', () => {
            detailModal = new bootstrap.Modal(document.getElementById('eventDetailModal'));
            checkLoginStatus();
            loadEvents();
        });

        function checkLoginStatus() {
            const userRaw = localStorage.getItem('userData');
            const navArea = document.getElementById('navUserArea');
            if (userRaw) {
                const user = JSON.parse(userRaw);
                navArea.innerHTML = `<div class="dropdown"><button class="btn btn-light dropdown-toggle border rounded-pill px-3 py-1" data-bs-toggle="dropdown"><i class="bi bi-person-circle"></i> ${user.username}</button><ul class="dropdown-menu dropdown-menu-end shadow border-0 mt-2 p-2"><li><a class="dropdown-item" href="dashboard.html">Tiket Saya</a></li><li><hr class="dropdown-divider"></li><li><button class="dropdown-item text-danger" onclick="logout()">Keluar</button></li></ul></div>`;
            } else {
                navArea.innerHTML = `<a href="user-login.html" class="btn btn-outline-primary rounded-pill px-4 fw-bold btn-sm">Masuk / Daftar</a>`;
            }
        }

        function logout() { localStorage.clear(); window.location.reload(); }

        async function loadEvents() {
            try {
                const res = await fetch('/api/events');
                allEvents = await res.json();
                renderEvents(allEvents);
            } catch (err) { console.error(err); }
        }

        function filterCategory(category) {
            document.querySelectorAll('.category-item').forEach(el => el.classList.remove('active'));
            document.getElementById(`btn-cat-${category}`).classList.add('active');
            renderEvents(category === 'All' ? allEvents : allEvents.filter(e => e.category === category));
        }

        function renderEvents(data) {
            const container = document.getElementById('event-list');
            container.innerHTML = ''; 
            if(data.length === 0) return container.innerHTML = `<div class="col-12 text-center py-5"><p class="text-secondary">Tidak ada event.</p></div>`;

            data.forEach(event => {
                const harga = new Intl.NumberFormat('id-ID').format(event.price);
                const isSoldOut = event.availableSeats <= 0;
                container.innerHTML += `
                    <div class="col-6 col-md-4 col-lg-3">
                        <div class="card-event" onclick="showDetail('${event._id}')">
                            <div class="card-img-top"><i class="bi bi-ticket-perforated fs-1 opacity-50"></i><span class="category-badge-img">${event.category || 'Event'}</span></div>
                            <div class="card-body">
                                <h5 class="event-title text-truncate">${event.name}</h5>
                                <div class="price-val">Rp ${harga}</div>
                                <button onclick="event.stopPropagation(); buyTicket('${event._id}')" class="btn btn-outline-book ${isSoldOut ? 'disabled' : ''}">${isSoldOut ? 'HABIS' : 'BELI'}</button>
                            </div>
                        </div>
                    </div>`;
            });
        }

        function showDetail(eventId) {
            const event = allEvents.find(e => e._id === eventId);
            if (!event) return;
            const harga = new Intl.NumberFormat('id-ID').format(event.price);
            document.getElementById('modalTitle').innerText = event.name;
            document.getElementById('modalPrice').innerText = `Rp ${harga}`;
            document.getElementById('modalDesc').innerText = event.description || "Deskripsi lengkap belum tersedia.";
            
            const btnBuy = document.getElementById('btnModalBuy');
            if (event.availableSeats <= 0) {
                btnBuy.innerText = "TIKET HABIS";
                btnBuy.classList.add('disabled', 'btn-secondary');
                btnBuy.classList.remove('btn-primary');
                btnBuy.removeAttribute('onclick');
            } else {
                btnBuy.innerText = "Beli Tiket Sekarang";
                btnBuy.classList.remove('disabled', 'btn-secondary');
                btnBuy.classList.add('btn-primary');
                btnBuy.onclick = function() { detailModal.hide(); buyTicket(eventId); };
            }
            detailModal.show();
        }

        function searchEvent() {
            const keyword = document.getElementById('searchInput').value.toLowerCase();
            renderEvents(allEvents.filter(e => e.name.toLowerCase().includes(keyword)));
        }

        // --- FUNGSI BELI TIKET (FIXED) ---
        async function buyTicket(eventId) {
            const userRaw = localStorage.getItem('userData');
            if (!userRaw) {
                Swal.fire({ title: 'Login Dulu', text: 'Silakan login member untuk membeli tiket.', icon: 'info', confirmButtonText: 'Ke Halaman Login' }).then((r) => { if(r.isConfirmed) window.location.href = 'user-login.html'; });
                return;
            }
            const user = JSON.parse(userRaw);
            const event = allEvents.find(e => e._id === eventId);

            const confirm = await Swal.fire({
                title: 'Konfirmasi Pembelian',
                html: `Beli tiket <b>${event.name}</b>?<br>Harga: <b>Rp ${new Intl.NumberFormat('id-ID').format(event.price)}</b>`,
                showCancelButton: true, confirmButtonText: 'Bayar Sekarang'
            });

            if (confirm.isConfirmed) {
                Swal.showLoading();
                try {
                    // Manggil API yang BENAR: /api/payment-token
                    const res = await fetch('/api/payment-token', {
                        method: 'POST', 
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            eventId, 
                            quantity: 1, 
                            customerName: user.fullName || user.username, 
                            customerEmail: user.email 
                        })
                    });
                    const data = await res.json();
                    Swal.close(); 

                    if (res.ok && data.token) {
                        window.snap.pay(data.token, {
                            onSuccess: function(result){ Swal.fire('Berhasil!', 'Tiket sedang diproses.', 'success').then(() => window.location.href = 'dashboard.html'); },
                            onPending: function(result){ Swal.fire('Menunggu Pembayaran', 'Silakan selesaikan pembayaran.', 'info'); },
                            onError: function(result){ Swal.fire('Gagal', 'Pembayaran gagal.', 'error'); }
                        });
                    } else { 
                        Swal.fire('Gagal', data.message || 'Error server.', 'error'); 
                    }
                } catch (err) { Swal.fire('Error', 'Gagal koneksi.', 'error'); }
            }
        }
    </script>

    <script>
        (async function() {
            try {
                // Cek status maintenance dari backend
                const res = await fetch('/api/maintenance');
                const data = await res.json();
                
                // Cek apakah admin login (biar admin tetep bisa akses)
                const isAdmin = localStorage.getItem('adminToken'); 

                // Jika maintenance aktif DAN user bukan admin, timpa layar
                if (data.isActive && !isAdmin) {
                    document.body.innerHTML = `
                        <style>
                            @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap');
                            body { margin: 0; padding: 0; font-family: 'Poppins', sans-serif; background: linear-gradient(-45deg, #0e1e3b, #2b1055, #0049CC, #4facfe); background-size: 400% 400%; animation: gradientBG 15s ease infinite; height: 100vh; display: flex; align-items: center; justify-content: center; overflow: hidden; }
                            @keyframes gradientBG { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
                            .glass-card { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(20px); border-radius: 24px; border: 1px solid rgba(255, 255, 255, 0.1); padding: 50px 40px; text-align: center; max-width: 500px; width: 90%; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); color: white; }
                            .floating-illustration { font-size: 80px; margin-bottom: 20px; display: inline-block; animation: float 3s ease-in-out infinite; }
                            @keyframes float { 0%, 100% { transform: translateY(0px); } 50% { transform: translateY(-20px); } }
                            h1 { font-size: 2rem; font-weight: 800; margin-bottom: 10px; background: linear-gradient(to right, #fff, #b0c0d6); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
                            p { color: #d1d5db; margin-bottom: 30px; }
                            .btn-retry { background: white; color: #0e1e3b; border: none; padding: 12px 35px; border-radius: 50px; font-weight: 700; cursor: pointer; transition: 0.3s; }
                            .btn-retry:hover { transform: scale(1.05); }
                        </style>
                        <div class="glass-card">
                            <div class="floating-illustration">üëæüõ†Ô∏è</div>
                            <h1>Lagi Didandanin! ‚ú®</h1>
                            <p>Sstt... Servernya lagi istirahat sebentar biar nanti makin ngebut. <br><br><b>Coba balik lagi nanti ya!</b></p>
                            <button onclick="location.reload()" class="btn-retry">Cek Lagi Dong ‚Üª</button>
                        </div>
                    `;
                }
            } catch (err) {
                console.log("Gagal cek maintenance status.");
            }
        })();
    </script>
</body>
</html>
