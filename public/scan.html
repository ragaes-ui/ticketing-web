<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gatekeeper V4</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <style>
        /* --- TEMA HACKER MATRIX --- */
        body { 
            background: #000; 
            color: #0f0; 
            font-family: 'Courier New', Courier, monospace; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            min-height: 100vh; 
            margin: 0;
            padding: 20px 0;
        }
        .scanner-box { 
            border: 2px solid #0f0; 
            padding: 25px; 
            border-radius: 10px; 
            width: 90%; 
            max-width: 480px; 
            box-shadow: 0 0 25px rgba(0, 255, 0, 0.4); 
            background: #050505; 
            position: relative;
        }
        input { 
            background: #111 !important; 
            border: 1px solid #0f0 !important; 
            color: #0f0 !important; 
            font-size: 1.2rem; 
            text-align: center; 
            font-weight: bold;
        }
        input::placeholder { color: #003300; }
        input:focus { box-shadow: 0 0 15px #0f0 !important; }

        .btn-scan { 
            background: #0f0; 
            color: black; 
            font-weight: bold; 
            font-size: 1.2rem; 
            border: none; 
            transition: 0.3s;
        }
        .btn-scan:hover { background: #fff; box-shadow: 0 0 20px #fff; }
        
        #camera-wrapper {
            width: 100%;
            height: 300px;
            background: #000;
            border: 1px dashed #0f0;
            margin-bottom: 20px;
            display: none;
            overflow: hidden;
            position: relative;
            border-radius: 5px;
        }
        #reader video {
            width: 100% !important;
            height: 100% !important;
            object-fit: cover;
        }

        .btn-reset {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 0.7rem;
            border: 1px solid #f44;
            color: #f44;
            background: transparent;
            padding: 2px 8px;
            border-radius: 5px;
            cursor: pointer;
            z-index: 10;
        }
        .btn-reset:hover { background: #f44; color: #000; }
    </style>
</head>
<body>

    <div class="scanner-box text-center">
        <button onclick="resetDatabase()" class="btn-reset">RESET DB</button>

        <h2 class="mb-2">üïµÔ∏è‚Äç‚ôÇÔ∏è GATE CONTROL</h2>
        <p class="mb-4 text-secondary small">V4.0 - AUTO CAMERA FIX</p>
        
        <button type="button" id="btnToggleCam" class="btn btn-outline-success w-100 mb-3 btn-sm">
            üì∑ AKTIFKAN KAMERA
        </button>

        <div id="camera-wrapper">
            <div id="reader" style="width:100%; height:100%;"></div>
        </div>

        <form id="scanForm">
            <div class="mb-4">
                <input type="text" id="ticketCode" class="form-control py-3" placeholder="SCAN / INPUT CODE" autocomplete="off" required>
            </div>
            <button type="submit" id="btnSubmit" class="btn btn-scan w-100 py-3">
                CHECK TICKET
            </button>
        </form>
    </div>

    <script>
        // --- 1. LOGIKA DATABASE LOKAL ---
        function validasiTiket(kode) {
            let usedTickets = JSON.parse(localStorage.getItem('db_tiket_used')) || [];
            if (usedTickets.includes(kode)) {
                return { sukses: false, pesan: 'TIKET SUDAH DIGUNAKAN!', detail: 'Sudah tercatat masuk sebelumnya.' };
            } else {
                usedTickets.push(kode);
                localStorage.setItem('db_tiket_used', JSON.stringify(usedTickets));
                return { sukses: true, pesan: 'ACCESS GRANTED', detail: 'Silakan Masuk.' };
            }
        }

        function resetDatabase() {
            Swal.fire({
                title: 'Reset Data?', text: "Semua tiket akan dianggap baru lagi.", icon: 'warning',
                showCancelButton: true, confirmButtonColor: '#f44', confirmButtonText: 'Reset', background: '#000', color: '#fff'
            }).then((res) => {
                if (res.isConfirmed) {
                    localStorage.removeItem('db_tiket_used');
                    Swal.fire({title:'Reset Berhasil', icon:'success', background:'#000', color:'#0f0'});
                }
            });
        }

        // --- 2. CONFIG KAMERA (PERBAIKAN UTAMA DISINI) ---
        const btnToggleCam = document.getElementById('btnToggleCam');
        const cameraWrapper = document.getElementById('camera-wrapper');
        const inputCode = document.getElementById('ticketCode');
        let html5QrCode = null; 
        let isCameraOn = false;

        btnToggleCam.addEventListener('click', () => {
            if (!isCameraOn) initCamera();
            else stopCamera();
        });

        async function initCamera() {
            // UI Loading
            cameraWrapper.style.display = "block";
            btnToggleCam.innerText = "‚è≥ MENCARI KAMERA...";
            btnToggleCam.disabled = true;

            html5QrCode = new Html5Qrcode("reader");

            // Config Scan
            const config = { fps: 10, qrbox: { width: 250, height: 250 } };

            try {
                // PERCOBAAN 1: Pakai Kamera Belakang (Environment)
                await html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess, onScanFailure);
                cameraSukses();
            } catch (err1) {
                console.warn("Kamera belakang gagal, mencoba kamera user/depan...", err1);
                
                try {
                    // PERCOBAAN 2: Pakai Kamera Depan/Laptop (User)
                    await html5QrCode.start({ facingMode: "user" }, config, onScanSuccess, onScanFailure);
                    cameraSukses();
                } catch (err2) {
                    // PERCOBAAN 3: Gagal Total
                    console.error("Gagal total:", err2);
                    cameraWrapper.style.display = "none";
                    btnToggleCam.innerText = "üì∑ AKTIFKAN KAMERA";
                    btnToggleCam.disabled = false;
                    
                    // Analisa Error
                    let msg = "Pastikan izin kamera aktif.";
                    if (location.protocol !== "https:" && location.hostname !== "localhost" && location.hostname !== "127.0.0.1") {
                        msg = "WAJIB HTTPS! Kamera diblokir browser karena website tidak aman (Not Secure).";
                    } else if (err2.name === "NotAllowedError") {
                        msg = "Izin Ditolak! Klik ikon gembok di browser dan izinkan kamera.";
                    } else if (err2.name === "NotFoundError") {
                        msg = "Perangkat kamera tidak ditemukan.";
                    }

                    Swal.fire({ title: 'KAMERA ERROR', text: msg, icon: 'error', background:'#000', color:'#f44' });
                }
            }
        }

        function cameraSukses() {
            isCameraOn = true;
            btnToggleCam.innerText = "‚ùå TUTUP KAMERA";
            btnToggleCam.classList.replace('btn-outline-success', 'btn-outline-danger');
            btnToggleCam.disabled = false;
        }

        async function stopCamera() {
            if (html5QrCode) {
                try {
                    await html5QrCode.stop();
                    html5QrCode.clear();
                } catch (e) {}
                cameraWrapper.style.display = "none";
                btnToggleCam.innerText = "üì∑ AKTIFKAN KAMERA";
                btnToggleCam.classList.replace('btn-outline-danger', 'btn-outline-success');
                isCameraOn = false;
            }
        }

        function onScanSuccess(decodedText) {
            inputCode.value = decodedText;
            stopCamera();
            // Bunyi Beep Kecil (Opsional)
            // new Audio('https://www.soundjay.com/buttons/beep-01a.mp3').play().catch(e=>{});
            document.getElementById('btnSubmit').click();
        }

        function onScanFailure(error) {}

        // --- 3. HANDLE SUBMIT ---
        document.getElementById('scanForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btnSubmit');
            const code = inputCode.value.trim();
            if (!code) return;

            const originalText = btn.innerText;
            btn.innerText = "CHECKING...";
            btn.disabled = true;

            await new Promise(r => setTimeout(r, 600)); // Efek mikir

            const hasil = validasiTiket(code);

            if (hasil.sukses) {
                await Swal.fire({
                    title: '‚úÖ ' + hasil.pesan,
                    html: `<h3 style="color:#fff">VALID</h3>Code: <b>${code}</b>`,
                    icon: 'success', background: '#000', color: '#0f0', confirmButtonColor: '#0f0', timer: 2000
                });
            } else {
                await Swal.fire({
                    title: '‚õî ACCESS DENIED',
                    html: `<h4 style="color:#f44">${hasil.pesan}</h4>`,
                    icon: 'error', background: '#000', color: '#f44', confirmButtonColor: '#f44'
                });
            }

            btn.innerText = originalText;
            btn.disabled = false;
            inputCode.value = '';
            inputCode.focus();
        });
    </script>
</body>
</html>
