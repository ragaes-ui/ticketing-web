<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gatekeeper Matrix v2</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <style>
        /* --- GAYA HACKER MATRIX --- */
        body { 
            background: #000; 
            color: #0f0; 
            font-family: 'Courier New', Courier, monospace; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            min-height: 100vh; 
            margin: 0;
            padding: 20px 0;
        }
        .scanner-box { 
            border: 2px solid #0f0; 
            padding: 25px; 
            border-radius: 10px; 
            width: 90%; 
            max-width: 480px; 
            box-shadow: 0 0 25px rgba(0, 255, 0, 0.4); 
            background: #050505; 
        }
        input { 
            background: #111 !important; 
            border: 1px solid #0f0 !important; 
            color: #0f0 !important; 
            font-size: 1.4rem; 
            text-align: center; 
            font-weight: bold;
        }
        input::placeholder { color: #003300; }
        input:focus { box-shadow: 0 0 15px #0f0 !important; }

        .btn-scan { 
            background: #0f0; 
            color: black; 
            font-weight: bold; 
            font-size: 1.2rem; 
            border: none; 
            transition: 0.3s;
        }
        .btn-scan:hover { background: #fff; box-shadow: 0 0 20px #fff; }
        
        /* --- AREA KAMERA CUSTOM (FIX UI) --- */
        #camera-wrapper {
            width: 100%;
            height: 300px; /* Tinggi kamera fix agar layout tidak lompat */
            background: #000;
            border: 1px dashed #0f0;
            margin-bottom: 20px;
            display: none; /* Default sembunyi */
            overflow: hidden;
            position: relative;
            border-radius: 5px;
        }
        /* Memaksa video agar fit di dalam kotak */
        #reader video {
            width: 100% !important;
            height: 100% !important;
            object-fit: cover;
        }
    </style>
</head>
<body>

    <div class="scanner-box text-center">
        <h2 class="mb-2">üïµÔ∏è‚Äç‚ôÇÔ∏è GATE CONTROL</h2>
        <p class="mb-4 text-secondary small">SYSTEM READY...</p>
        
        <button type="button" id="btnToggleCam" class="btn btn-outline-success w-100 mb-3 btn-sm">
            üì∑ AKTIFKAN KAMERA
        </button>

        <div id="camera-wrapper">
            <div id="reader" style="width:100%; height:100%;"></div>
        </div>

        <form id="scanForm">
            <div class="mb-4">
                <input type="text" id="ticketCode" class="form-control py-3" placeholder="SCAN / INPUT CODE" autocomplete="off" required>
            </div>
            <button type="submit" id="btnSubmit" class="btn btn-scan w-100 py-3">
                CHECK TICKET
            </button>
        </form>
    </div>

    <script>
        // --- LOGIKA BARU (Direct Camera Mode) ---

        const btnToggleCam = document.getElementById('btnToggleCam');
        const cameraWrapper = document.getElementById('camera-wrapper');
        const inputCode = document.getElementById('ticketCode');
        
        let html5QrCode = null; // Instance scanner
        let isCameraOn = false; // Status kamera

        // 1. Tombol Klik Kamera
        btnToggleCam.addEventListener('click', async () => {
            if (!isCameraOn) {
                startCamera();
            } else {
                stopCamera();
            }
        });

        // 2. Fungsi Menyalakan Kamera
        async function startCamera() {
            try {
                // Munculkan Wadah
                cameraWrapper.style.display = "block";
                btnToggleCam.innerText = "‚è≥ MEMUAT KAMERA...";
                btnToggleCam.disabled = true;

                // Inisialisasi Library Mode Manual
                html5QrCode = new Html5Qrcode("reader");

                const config = { 
                    fps: 10, 
                    qrbox: { width: 250, height: 250 },
                    aspectRatio: 1.0 
                };

                // Mulai Scanning (Kamera Belakang / Environment)
                await html5QrCode.start(
                    { facingMode: "environment" }, 
                    config, 
                    onScanSuccess, 
                    onScanFailure
                );

                // Jika berhasil nyala:
                isCameraOn = true;
                btnToggleCam.innerText = "‚ùå TUTUP KAMERA";
                btnToggleCam.classList.replace('btn-outline-success', 'btn-outline-danger');
                btnToggleCam.disabled = false;

            } catch (err) {
                console.error("Gagal start kamera:", err);
                cameraWrapper.style.display = "none";
                btnToggleCam.innerText = "üì∑ AKTIFKAN KAMERA";
                btnToggleCam.disabled = false;

                // Notifikasi Error
                Swal.fire({
                    title: 'KAMERA GAGAL',
                    text: 'Pastikan izin kamera aktif dan dibuka via HTTPS/Localhost.',
                    icon: 'error',
                    background: '#000',
                    color: '#f44'
                });
            }
        }

        // 3. Fungsi Mematikan Kamera
        async function stopCamera() {
            if (html5QrCode) {
                try {
                    await html5QrCode.stop();
                    html5QrCode.clear();
                    
                    // Reset Tampilan
                    cameraWrapper.style.display = "none";
                    btnToggleCam.innerText = "üì∑ AKTIFKAN KAMERA";
                    btnToggleCam.classList.replace('btn-outline-danger', 'btn-outline-success');
                    isCameraOn = false;
                } catch (err) {
                    console.log("Error stop:", err);
                }
            }
        }

        // 4. Jika Scan Berhasil
        function onScanSuccess(decodedText, decodedResult) {
            console.log(`Code Scanned: ${decodedText}`);
            
            // Isi Input
            inputCode.value = decodedText;

            // Matikan kamera agar hemat baterai
            stopCamera();

            // Auto Submit Form
            document.getElementById('btnSubmit').click();
        }

        // 5. Jika Scan Gagal (Looping terus mencari QR)
        function onScanFailure(error) {
            // Biarkan kosong agar console bersih
        }


        // --- LOGIKA FORM & MOCKUP API (Sama seperti sebelumnya) ---
        document.getElementById('scanForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btnSubmit');
            const code = inputCode.value.trim();

            if (!code) return;

            const originalText = btn.innerText;
            btn.innerText = "SEARCHING...";
            btn.disabled = true;

            try {
                // --- MOCKUP / SIMULASI API ---
                await new Promise(r => setTimeout(r, 800)); // Delay
                const data = { valid: true, data: { event: 'HACKER MEETUP', name: 'GUEST USER' } };
                // -----------------------------

                if (data.valid) {
                    await Swal.fire({
                        title: '‚úÖ ACCESS GRANTED',
                        html: `<h3 style="color:#fff">${data.data.event}</h3>Code: <b>${code}</b>`,
                        icon: 'success',
                        background: '#000',
                        color: '#0f0',
                        confirmButtonColor: '#0f0',
                        timer: 2000
                    });
                } else {
                    await Swal.fire({ title: '‚õî DENIED', icon: 'error', background: '#000', color: '#f44' });
                }

            } catch (err) {
                console.error(err);
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
                inputCode.value = '';
                inputCode.focus();
            }
        });
    </script>
</body>
</html>
