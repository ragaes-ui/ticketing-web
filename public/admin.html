<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | RCELLFEST</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <script>const token = localStorage.getItem('adminToken'); if (!token) window.location.href = 'login.html';</script>
    <style>body{background-color:#f0f2f5;padding-top:80px} .card{border:none;border-radius:12px;box-shadow:0 4px 6px -1px rgba(0,0,0,0.1)}</style>
</head>
<body class="pb-5">
    <nav class="navbar navbar-expand-lg fixed-top bg-white border-bottom">
        <div class="container-fluid px-4">
            <a class="navbar-brand fw-bold text-primary" href="#">ADMIN PORTAL</a>
            <div class="d-flex gap-3">
                <a href="index.html" class="btn btn-outline-secondary btn-sm rounded-pill" target="_blank">Lihat Website</a>
                <button onclick="logout()" class="btn btn-danger btn-sm rounded-pill">Logout</button>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row mb-4">
            <div class="col-12">
                <div class="card border-warning">
                    <div class="card-body d-flex justify-content-between align-items-center bg-warning-subtle">
                        <div><h5 class="fw-bold mb-0">Maintenance Mode</h5></div>
                        <div class="form-check form-switch"><input class="form-check-input" type="checkbox" id="switchMaintenance"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row g-4">
            <div class="col-lg-4">
                <div class="card sticky-top" style="top: 100px;">
                    <div class="card-header fw-bold">Tambah Event / Produk</div>
                    <div class="card-body">
                        <form id="formEvent">
                            <div class="mb-3">
                                <label class="form-label">Kategori</label>
                                <select id="category" class="form-select" onchange="checkCategory(this)">
                                    <option value="General">General</option>
                                    <option value="Konser">Konser Musik</option>
                                    <option value="Olahraga">Olahraga</option>
                                    <option value="Streaming" class="fw-bold text-primary">ðŸŽ¥ Akun Streaming</option>
                                </select>
                            </div>
                            <div class="mb-3"><label class="form-label">Nama</label><input type="text" id="name" class="form-control" required></div>
                            <div class="mb-3"><label class="form-label">Lokasi/Platform</label><input type="text" id="location" class="form-control" required></div>
                            <div class="mb-3"><label class="form-label">Tanggal</label><input type="datetime-local" id="date" class="form-control" required></div>
                            <div class="mb-3">
                                <label class="form-label">Deskripsi / Akun</label>
                                <textarea id="description" class="form-control" rows="4"></textarea>
                                <small class="text-muted" id="descHint"></small>
                            </div>
                            <div class="row g-2">
                                <div class="col-6 mb-3"><label class="form-label">Harga</label><input type="number" id="price" class="form-control" required></div>
                                <div class="col-6 mb-3"><label class="form-label">Stok</label><input type="number" id="capacity" class="form-control" required></div>
                            </div>
                            <button type="submit" class="btn btn-primary w-100">Publish</button>
                        </form>
                    </div>
                </div>
            </div>

            <div class="col-lg-8">
                <div class="card">
                    <div class="card-header d-flex justify-content-between"><span>Database Event</span><button class="btn btn-sm btn-light border" onclick="loadTable()">Refresh</button></div>
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead><tr><th>Produk</th><th>Harga</th><th>Stok</th><th class="text-end">Aksi</th></tr></thead>
                            <tbody id="tableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="editModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">Edit Data</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <form id="formEdit">
                        <input type="hidden" id="editId">
                        <div class="mb-2"><label>Nama</label><input type="text" id="editName" class="form-control"></div>
                        <div class="mb-2"><label>Kategori</label><select id="editCategory" class="form-select"><option value="General">General</option><option value="Konser">Konser</option><option value="Streaming">Streaming</option></select></div>
                        <div class="mb-2"><label>Lokasi</label><input type="text" id="editLocation" class="form-control"></div>
                        <div class="mb-2"><label>Tanggal</label><input type="datetime-local" id="editDate" class="form-control"></div>
                        <div class="mb-2"><label>Deskripsi/Akun</label><textarea id="editDescription" class="form-control" rows="3"></textarea></div>
                        <div class="row">
                            <div class="col-6"><label>Harga</label><input type="number" id="editPrice" class="form-control"></div>
                            <div class="col-6"><label>Stok Sisa</label><input type="number" id="editStock" class="form-control text-danger"></div>
                            <input type="hidden" id="editCapacity">
                        </div>
                    </form>
                </div>
                <div class="modal-footer"><button onclick="saveEdit()" class="btn btn-primary">Simpan</button></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        const editModal = new bootstrap.Modal(document.getElementById('editModal'));
        let eventsData = []; 
        const switchMaint = document.getElementById('switchMaintenance');

        function checkCategory(select) {
            const desc = document.getElementById('description');
            if (select.value === 'Streaming') {
                desc.placeholder = "Format: Email | Password | Expired\nContoh: user@gmail.com | pass123 | 30 Hari";
                document.getElementById('descHint').innerText = "Info: Masukkan kredensial akun di sini.";
            } else {
                desc.placeholder = "Deskripsi Event...";
                document.getElementById('descHint').innerText = "";
            }
        }

        async function checkMaintenanceStatus() {
            try { const res = await fetch('/api/maintenance'); const data = await res.json(); if(switchMaint) switchMaint.checked = data.isActive; } catch (err) {}
        }

        if(switchMaint) {
            switchMaint.addEventListener('change', async function() {
                const isActive = this.checked;
                try { await fetch('/api/maintenance', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ isActive }) }); Swal.fire('Sukses', 'Status berubah', 'success'); } catch (err) { this.checked = !isActive; }
            });
        }
        
        async function loadTable() {
            try {
                const res = await fetch('/api/events'); eventsData = await res.json();
                const tbody = document.getElementById('tableBody'); tbody.innerHTML = '';
                eventsData.forEach(ev => {
                    let icon = ev.category === 'Streaming' ? 'ðŸŽ¥' : 'ðŸŽ«';
                    tbody.innerHTML += `<tr><td><div>${icon} ${ev.name}</div><small class="text-muted">${ev.category}</small></td><td>${ev.price}</td><td>${ev.availableSeats}</td><td class="text-end"><button onclick="bukaModalEdit('${ev._id}')" class="btn btn-sm btn-light">Edit</button><button onclick="hapusKonser('${ev._id}')" class="btn btn-sm btn-danger ms-1">Hapus</button></td></tr>`;
                });
            } catch (err) {}
        }

        function bukaModalEdit(id) {
            const ev = eventsData.find(e => e._id === id);
            if (ev) {
                document.getElementById('editId').value = ev._id; document.getElementById('editName').value = ev.name;
                document.getElementById('editCategory').value = ev.category; document.getElementById('editLocation').value = ev.location;
                const d = new Date(ev.date); d.setMinutes(d.getMinutes() - d.getTimezoneOffset());
                document.getElementById('editDate').value = d.toISOString().slice(0,16);
                document.getElementById('editPrice').value = ev.price; document.getElementById('editStock').value = ev.availableSeats;
                document.getElementById('editCapacity').value = ev.totalCapacity; document.getElementById('editDescription').value = ev.description;
                editModal.show();
            }
        }

        async function saveEdit() {
            const id = document.getElementById('editId').value;
            const data = {
                name: document.getElementById('editName').value, category: document.getElementById('editCategory').value,
                location: document.getElementById('editLocation').value, date: document.getElementById('editDate').value,
                price: document.getElementById('editPrice').value, description: document.getElementById('editDescription').value,
                availableSeats: document.getElementById('editStock').value, capacity: document.getElementById('editCapacity').value
            };
            await fetch(`/api/events/${id}`, { method: 'PUT', headers: {'Content-Type':'application/json'}, body: JSON.stringify(data) });
            editModal.hide(); loadTable(); Swal.fire('Sukses', 'Data update', 'success');
        }

        document.getElementById('formEvent').addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = {
                name: document.getElementById('name').value, category: document.getElementById('category').value,
                location: document.getElementById('location').value, date: document.getElementById('date').value,
                price: document.getElementById('price').value, capacity: document.getElementById('capacity').value,
                description: document.getElementById('description').value
            };
            await fetch('/api/events', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(data) });
            loadTable(); e.target.reset(); Swal.fire('Sukses', 'Tersimpan', 'success');
        });

        async function hapusKonser(id) { if((await Swal.fire({ title:'Hapus?', showCancelButton:true })).isConfirmed) { await fetch(`/api/events/${id}`, { method: 'DELETE' }); loadTable(); } }
        function logout() { localStorage.removeItem('adminToken'); window.location.href = 'login.html'; }
        loadTable(); checkMaintenanceStatus(); checkCategory(document.getElementById('category'));
    </script>
</body>
</html>
